{% extends 'base.html' %}
{% load static %}

{% block title %}
  {{ case.yfcaseCaseNumber }} - 案件詳細
{% endblock %}

{% block content %}
  <div class="row fade-in">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0"><i class="fas fa-file-alt me-2 text-primary"></i>案件詳細</h1>
        <div class="btn-group" role="group">
          {% if case.user == user or user.is_staff %}
            <a href="{% url 'cases:case_update' case.pk %}" class="btn btn-warning"><i class="fas fa-edit me-1"></i>編輯</a>
            <a href="{% url 'cases:case_delete' case.pk %}" class="btn btn-danger"><i class="fas fa-trash me-1"></i>刪除</a>
          {% endif %}
          <a href="{% url 'cases:case_list' %}" class="btn btn-secondary"><i class="fas fa-arrow-left me-1"></i>返回列表</a>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">{{ case.yfcaseCaseNumber }}</h5>
        </div>
        <div class="card-body">
          <!-- Bootstrap Tabs -->
          <ul class="nav nav-tabs" id="caseDetailTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab" aria-controls="basic" aria-selected="true"><i class="fas fa-info-circle me-1"></i>基本資訊</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="address-tab" data-bs-toggle="tab" data-bs-target="#address" type="button" role="tab" aria-controls="address" aria-selected="false"><i class="fas fa-map-marker-alt me-1"></i>地址資訊</button>
            </li>
          </ul>

          <div class="tab-content" id="caseDetailTabContent">
            <!-- 基本資訊 Tab -->
            <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
              <div class="row">
                <div class="col-md-6">
                  <table class="table table-borderless table-sm">
                    <tr>
                      <th width="35%">案號：</th>
                      <td>
                        <strong class="text-primary">{{ case.yfcaseCaseNumber }}</strong>
                      </td>
                    </tr>
                    <tr>
                      <th>所屬公司：</th>
                      <td>
                        {% if case.yfcaseCompany == '揚富開發有限公司' %}
                          <span class="badge bg-primary rounded-pill me-2" style="font-size: 0.8em;">揚</span>
                        {% elif case.yfcaseCompany == '鉅鈦開發有限公司' %}
                          <span class="badge bg-success rounded-pill me-2" style="font-size: 0.8em;">鉅</span>
                        {% endif %}
                        {{ case.yfcaseCompany|default:'未設定' }}
                      </td>
                    </tr>
                    <tr>
                      <th>完整地址：</th>
                      <td>
                        {% if case.yfcaseCity or case.yfcaseStreet %}
                          <strong class="text-primary">{{ case.get_full_address }}</strong>
                        {% else %}
                          未設定
                        {% endif %}
                      </td>
                    </tr>
                  </table>
                </div>
                <div class="col-md-6">
                  <table class="table table-borderless table-sm">
                    <tr>
                      <th width="35%">區域負責人：</th>
                      <td>
                        <i class="fas fa-user me-1 text-muted"></i>
                        {{ case.user.userFullName|default:case.user.email }}
                      </td>
                    </tr>
                    <tr>
                      <th>案件狀態：</th>
                      <td>
                        {% if case.yfcaseCaseStatus == '在途' %}
                          <span class="badge bg-warning">在途</span>
                        {% elif case.yfcaseCaseStatus == '結案' %}
                          <span class="badge bg-success">結案</span>
                        {% else %}
                          <span class="badge bg-light text-dark">{{ case.yfcaseCaseStatus|default:'未設定' }}</span>
                        {% endif %}
                      </td>
                    </tr>
                  </table>
                </div>
              </div>

              <!-- 完整地址區塊 -->
              <div class="row">
                <div class="col-md-12">
                  <table class="table table-borderless table-sm">
                    <tr></tr>
                  </table>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <table class="table table-borderless table-sm">
                    <tr>
                      <th width="35%">建立時間：</th>
                      <td>
                        <i class="fas fa-calendar-plus me-1 text-muted"></i>
                        {{ case.yfcaseTimestamp|date:'Y-m-d H:i:s' }}
                      </td>
                    </tr>
                  </table>
                </div>
                <div class="col-md-6">
                  <table class="table table-borderless table-sm">
                    <tr>
                      <th width="35%">最後更新：</th>
                      <td>
                        <i class="fas fa-calendar-check me-1 text-muted"></i>
                        {{ case.yfcaseUpdated|date:'Y-m-d H:i:s' }}
                      </td>
                    </tr>
                  </table>
                </div>
              </div>
              <!-- 基本資訊 Tab 結尾加上按鈕 -->
              <div class="d-flex justify-content-end gap-2 mt-3">
                {% if case.user == user or user.is_staff %}
                  <button type="button" class="btn btn-warning" id="editCaseBtn"><i class="fas fa-edit me-1"></i>編輯</button>
                  <a href="{% url 'cases:case_delete' case.pk %}" class="btn btn-danger"><i class="fas fa-trash me-1"></i>刪除</a>
                {% endif %}
              </div>
            </div>

            <!-- 地址資訊 Tab -->
            <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
              <div class="row mt-3">
                <div class="col-md-6">
                  <h6 class="text-primary mb-3"><i class="fas fa-map-marker-alt me-1"></i>行政區域</h6>
                  <table class="table table-borderless">
                    <tr>
                      <th width="35%">縣市：</th>
                      <td>{{ case.yfcaseCity.name|default:'未設定' }}</td>
                    </tr>
                    <tr>
                      <th>鄉鎮區里：</th>
                      <td>{{ case.yfcaseTownship.name|default:'未設定' }}</td>
                    </tr>
                    <tr>
                      <th>段號：</th>
                      <td>{{ case.yfcaseBigSection|default:'未設定' }}</td>
                    </tr>
                    <tr>
                      <th>小段：</th>
                      <td>{{ case.yfcaseSmallSection|default:'未設定' }}</td>
                    </tr>
                    <tr>
                      <th>村里：</th>
                      <td>{{ case.yfcaseVillage|default:'未設定' }}</td>
                    </tr>
                  </table>
                </div>
                <div class="col-md-6">
                  <h6 class="text-primary mb-3"><i class="fas fa-home me-1"></i>詳細地址</h6>
                  <table class="table table-borderless">
                    <tr>
                      <th width="35%">街路：</th>
                      <td>{{ case.yfcaseStreet|default:'未設定' }}</td>
                    </tr>
                    <tr>
                      <th>段：</th>
                      <td>{{ case.yfcaseSection|default:'未設定' }}</td>
                    </tr>
                    <tr>
                      <th>巷：</th>
                      <td>{{ case.yfcaseLane|default:'未設定' }}</td>
                    </tr>
                    <tr>
                      <th>弄：</th>
                      <td>{{ case.yfcaseAlley|default:'未設定' }}</td>
                    </tr>
                    <tr>
                      <th>號：</th>
                      <td>{{ case.yfcaseNumber|default:'未設定' }}</td>
                    </tr>
                    <tr>
                      <th>樓層：</th>
                      <td>{{ case.yfcaseFloor|default:'未設定' }}</td>
                    </tr>
                    <tr>
                      <th>鄰：</th>
                      <td>{{ case.yfcaseNeighbor|default:'未設定' }}</td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="editCaseModal" tabindex="-1" aria-labelledby="editCaseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editCaseModalLabel">編輯案件</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="editCaseModalBody">
          <!-- 編輯表單內容將由 AJAX 載入 -->
          <div class="text-center text-muted py-5">
            <i class="fas fa-spinner fa-spin"></i> 載入中...
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <!-- 載入縣市鄉鎮 JavaScript -->
  <script src="{% static 'js/cityTownship.js' %}"></script>
  <script>
$(function() {
  $('#editCaseBtn').on('click', function(e) {
    e.preventDefault();
    var myModal = new bootstrap.Modal(document.getElementById('editCaseModal'));
    myModal.show();
    $('#editCaseModalBody').html('<div class="text-center text-muted py-5"><i class="fas fa-spinner fa-spin"></i> 載入中...</div>');
    $.ajax({
      url: '{% url 'cases:case_update' case.pk %}',
      type: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      },
      success: function(data) {
        $('#editCaseModalBody').html(data);
        // 重新初始化縣市鄉鎮選擇器
        if (typeof CityTownshipSelector !== 'undefined') {
          // 等待 DOM 更新完成後再初始化
          setTimeout(function() {
            window.caseCityTownshipSelector = new CityTownshipSelector(
              'id_yfcaseCity',
              'id_yfcaseTownship',
              {
                apiUrl: '{% url "cases:get_townships" %}'
              }
            );
          }, 100);
        }
      }
    });
  });

  // 動態代理表單提交
  $(document).on('submit', '#editCaseModalBody form', function(e) {
    e.preventDefault();
    var $form = $(this);
    $.ajax({
      url: $form.attr('action'),
      type: 'POST',
      data: $form.serialize(),
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      },
      success: function(data) {
        console.log('AJAX Response:', data);
        // 檢查是否為 JSON 響應（成功）
        if (typeof data === 'object' && data.success) {
          // 成功，關閉modal並刷新
          var myModal = bootstrap.Modal.getInstance(document.getElementById('editCaseModal'));
          myModal.hide();
          location.reload();
        } else {
          // 有錯誤，重新渲染表單
          $('#editCaseModalBody').html(data);
        }
      },
      error: function(xhr, status, error) {
        console.error('AJAX Error:', error);
        alert('發生錯誤，請重試');
      }
    });
  });
});
</script>
{% endblock %}
